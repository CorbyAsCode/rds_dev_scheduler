{
"AWSTemplateFormatVersion" : "2010-09-09",
 
  "Description" : "Postgres RDS Instance creation template ",  
 
  "Parameters": {
 
    "DBInstanceName": {
      "Description" : "Postgres instance name, max 8 alphanumeric characters",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "8",
      "AllowedPattern" : "[a-zA-Z][a-zA-Z0-9]*",
      "ConstraintDescription" : "must begin with a letter and contain only alphanumeric characters.",
      "Default": "corbyDb"
    },

    "DBName": {
      "Description" : "Postgres database name, should be same as Postgres instance name",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "8",
      "AllowedPattern" : "[a-zA-Z][a-zA-Z0-9]*",
      "ConstraintDescription" : "must begin with a letter and contain only alphanumeric characters.",
      "Default": "corbyDb"
    },
 
    "AdminUsername": {
      "Default": "DBadmin",
      "Description" : "The database admin account username",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "8",
      "AllowedPattern" : "[a-zA-Z][a-zA-Z0-9]*",
      "ConstraintDescription" : "must begin with a letter and contain only alphanumeric characters."
    },
 
    "AdminUserPassword": {
      "NoEcho": "true",
      "Description" : "The database admin account password",
      "Type": "String",
      "MinLength": "8",
      "Default": "DBadmin!"
    },
 
    "DBClass" : {
      "Default": "db.t2.micro",
      "Description" : "Database instance class",
      "Type" : "String",
      "AllowedValues" : [ "db.t2.micro", "db.t2.large", "db.m4.large", "db.m4.xlarge", "db.m4.2xlarge", 
                          "db.m4.4xlarge", "db.m4.10xlarge", "db.m3.medium", "db.m3.large", 
                          "db.m3.xlarge","db.m3.2xlarge", "db.r3.large","db.r3.xlarge", 
                          "db.r3.2xlarge", "db.r3.4xlarge", "db.r3.8xlarge", "db.cr1.8xlarge" ],                          
      "ConstraintDescription" : "must select a valid database instance type."
    },

    "DBEngine": { 
      "Default": "postgres",
      "Description" : "Postgres RDS database Engine",
      "Type": "String"
    },

    "DBEngineVersion": {
      "Default": "9.5.4",
      "Description" : "Postgres database version",
      "Type": "String",
      "AllowedValues" : [ "9.6.1", "9.5.4", "9.5.2", "9.4.9", "9.4.7", "9.4.5", "9.4.4", "9.4.1", 
                          "9.3.12", "9.3.10", "9.3.6", "9.3.5", "9.3.3", "9.3.2", "9.3.1" ],
                          
      "ConstraintDescription" : "Must select a valid DB Engine Version."
    },

    "DBSize" : {
      "Default": "5",
      "Description" : "The size of the database (GB)",
      "Type": "Number",
      "MinValue": "5",
      "MaxValue": "6144",
      "ConstraintDescription" : "Must be between 10 and 6144 GB"
    },

    "DBLicenseModel": { 
      "Default": "postgresql-license",
      "Description" : "Postgres RDS database license model",
      "Type": "String"
    },

    "DBBackupRetentionPeriod": {
      "Default": "0",
      "Description" : "Number of days to retain DB backup",
      "Type": "String"
    },

    "DBPreferredBackupWindow": {
      "Default": "",
      "Description" : "Postgres backup window",
      "Type": "String"
    },

    "DBPreferredMaintenanceWindow": {
      "Default": "",
      "Description" : "Postgres maintenance window",
      "Type": "String"
    },

    "MultiAZDeployment": { 
      "Default": "false",
      "Description" : "Create Multi-AZ Postgres RDS database instance",
      "Type": "String",
      "AllowedValues" : [ "true", "false" ],
      "ConstraintDescription" : "Must be either true or false."
    },

    "DBStorageType": { 
      "Default": "gp2",
      "Description" : "Postgres RDS Instance Storage Type",
      "Type": "String",
      "AllowedValues" : [ "gp2", "io1" ],
      "ConstraintDescription" : "Must select a valid DB Storage Type."
    }, 

    "DBStorageEncrypted": { 
      "Default": "false",
      "Description" : "Encrypted Postgres RDS database instance",
      "Type": "String",
      "AllowedValues" : [ "true", "false" ],
      "ConstraintDescription" : "Must be either true or false."
    },

    "PublicAccessibility": { 
      "Default": "false",
      "Description" : "Postgres RDS Instance Public Accessibility",
      "Type": "String",
      "AllowedValues" : [ "true", "false" ],
      "ConstraintDescription" : "Must be either true or false."
    },

    "CopyInstTagsToSnapshot": { 
      "Default": "true",
      "Description" : "Copy Postgres RDS database instance Tags To Snapshot",
      "Type": "String",
      "AllowedValues" : [ "true", "false" ],
      "ConstraintDescription" : "Must be either true or false."
    },

    "AutoInstMinorVersionUpgrade": { 
      "Default": "false",
      "Description" : "Automatic Minor Version Upgrade",
      "Type": "String",
      "AllowedValues" : [ "true", "false" ],
      "ConstraintDescription" : "Must be either true or false."
    },

   "TagAGS": {
      "Description": "Tag for AGS",
      "Type": "String",
      "Default": "corby_ags"
    },

   "TagCostCenter": {
      "Description": "Tag for Cost Center",
      "Type": "String",
      "Default": "test_cost_center"
    },

   "TagOwner": {
      "Description" : "Tag for Owner",
      "Type": "String",
      "Default": "corby_owner"
    },
    
    "DBSnapshotIdentifier": {
      "Description": "The RDS snapshot name to restore to the new DB instance.",
      "Type": "String",
      "Default": ""
    }
  },
  
  "Conditions" : {
    "UseDbSnapshot" : {
      "Fn::Not" : [{
        "Fn::Equals" : [
          {"Ref" : "DBSnapshotIdentifier"},
          ""
        ]
      }]
    }
  },
 
 "Resources" : {

      "DBParameterGroup": {
          "Type": "AWS::RDS::DBParameterGroup",
          "Properties": {
             "Description" : "Database Parameter Group",
             "Family": "postgres9.5",
             "Parameters" : {
                 "timezone" : "EST"
             }
	      }	
      },
 
      "PostgresDB" : {
          "Type" : "AWS::RDS::DBInstance",
          "DeletionPolicy": "Snapshot",
		  "Properties" : {
			  "DBName" : { 
			    "Fn::If": [
			      "UseDbSnapshot",
			      { "Ref": "AWS::NoValue" },
			      { "Ref" : "DBName" }
			    ]
			  },
			  "DBSnapshotIdentifier": {
			    "Fn::If": [
			      "UseDbSnapshot",
			      { "Ref": "DBSnapshotIdentifier" },
			      { "Ref": "AWS::NoValue" }
			    ]
			  },
			  "AllocatedStorage" : { "Ref" : "DBSize" },
			  "DBInstanceClass" : { "Ref" : "DBClass" },
			  "Engine" : { "Ref" : "DBEngine" },
			  "EngineVersion" : { "Ref" : "DBEngineVersion" },
			  "LicenseModel" : { "Ref" : "DBLicenseModel" },
			  "MasterUsername" : { "Ref" : "AdminUsername" } ,
			  "MasterUserPassword" : { "Ref" : "AdminUserPassword" },
			  "DBInstanceIdentifier" : { "Ref" : "DBInstanceName" },
			  "DBParameterGroupName" : {"Ref" : "DBParameterGroup" },
			  "Port" : "5432", 
			  "PubliclyAccessible" : {"Ref" : "PublicAccessibility" },
			  "BackupRetentionPeriod" : { "Ref" : "DBBackupRetentionPeriod" },
			  "PreferredBackupWindow" : {"Ref" : "DBPreferredBackupWindow" },
			  "PreferredMaintenanceWindow" : { "Ref" : "DBPreferredMaintenanceWindow" }, 
			  "MultiAZ" : { "Ref" : "MultiAZDeployment" },
			  "StorageType" : { "Ref" : "DBStorageType" },
			  "StorageEncrypted" : {"Ref" : "DBStorageEncrypted" },
			  "CopyTagsToSnapshot" : {"Ref" : "CopyInstTagsToSnapshot" },
			  "AutoMinorVersionUpgrade" : {"Ref" : "AutoInstMinorVersionUpgrade" },
			  "Tags": [ 
				  { 
					  "Key" : "AGS", 
					  "Value" : { "Ref" : "TagAGS"  } 
				  }, 
				  { 
					  "Key" : "Cost Center", 
					  "Value" : { "Ref" : "TagCostCenter"  } 
				  }, 
				  { 
					  "Key" : "Owner", 
					  "Value" : { "Ref" : "TagOwner"  } 
				  },
				  {    "Key": "Template",
				       "Value": "RDS_PostgreSQL_CloudFormation_Template"
				  }
			  ]
  	      }
	  }
  },

  "Outputs" : {
    "JDBCConnectionString": {
      "Description" : "JDBC connection string for database",
      "Value" : { "Fn::Join": [ "", [ "jdbc:Postgres://",
                                      { "Fn::GetAtt": [ "PostgresDB", "Endpoint.Address" ] },
                                      ":",
                                      { "Fn::GetAtt": [ "PostgresDB", "Endpoint.Port" ] },
                                      "/",
                                      { "Ref": "DBName" }]]}
    }
  }
}